/*!
 * LMV v7.51.0
 * 
 * Copyright 2021 Autodesk, Inc.
 * All rights reserved.
 * 
 * This computer source code and related instructions and comments are the
 * unpublished confidential and proprietary information of Autodesk, Inc.
 * and are protected under Federal copyright and state trade secret law.
 * They may not be disclosed to, copied or used by any third party without
 * the prior written consent of Autodesk, Inc.
 * 
 * Autodesk Forge Viewer Usage Limitations:
 * 
 * The Autodesk Forge viewer can only be used to view files generated by
 * Autodesk Forge services. The Autodesk Forge Viewer JavaScript must be
 * delivered from an Autodesk hosted URL.
 */
Autodesk.Extensions.SceneBuilder=function(e){var t={};function r(i){if(t[i])return t[i].exports;var n=t[i]={i:i,l:!1,exports:{}};return e[i].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,i){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(i,n,function(t){return e[t]}.bind(null,n));return i},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=809)}({133:function(e,t){function r(){}function i(e){this._tree=e,this._ancestors=[],this._cursor=null}r.prototype.clear=function(){this._root=null,this.size=0},r.prototype.find=function(e){for(var t=this._root;null!==t;){var r=this._comparator(e,t.data);if(0===r)return t.data;t=t.get_child(r>0)}return null},r.prototype.findIter=function(e){for(var t=this._root,r=this.iterator();null!==t;){var i=this._comparator(e,t.data);if(0===i)return r._cursor=t,r;r._ancestors.push(t),t=t.get_child(i>0)}return null},r.prototype.lowerBound=function(e){for(var t=this._root,r=this.iterator(),i=this._comparator;null!==t;){var n=i(e,t.data);if(0===n)return r._cursor=t,r;r._ancestors.push(t),t=t.get_child(n>0)}for(var o=r._ancestors.length-1;o>=0;--o)if(i(e,(t=r._ancestors[o]).data)<0)return r._cursor=t,r._ancestors.length=o,r;return r._ancestors.length=0,r},r.prototype.upperBound=function(e){for(var t=this.lowerBound(e),r=this._comparator;null!==t.data()&&0===r(t.data(),e);)t.next();return t},r.prototype.min=function(){var e=this._root;if(null===e)return null;for(;null!==e.left;)e=e.left;return e.data},r.prototype.max=function(){var e=this._root;if(null===e)return null;for(;null!==e.right;)e=e.right;return e.data},r.prototype.iterator=function(){return new i(this)},r.prototype.each=function(e){for(var t,r=this.iterator();null!==(t=r.next());)if(!1===e(t))return},r.prototype.reach=function(e){for(var t,r=this.iterator();null!==(t=r.prev());)if(!1===e(t))return},i.prototype.data=function(){return null!==this._cursor?this._cursor.data:null},i.prototype.next=function(){if(null===this._cursor){var e=this._tree._root;null!==e&&this._minNode(e)}else{var t;if(null===this._cursor.right)do{if(t=this._cursor,!this._ancestors.length){this._cursor=null;break}this._cursor=this._ancestors.pop()}while(this._cursor.right===t);else this._ancestors.push(this._cursor),this._minNode(this._cursor.right)}return null!==this._cursor?this._cursor.data:null},i.prototype.prev=function(){if(null===this._cursor){var e=this._tree._root;null!==e&&this._maxNode(e)}else{var t;if(null===this._cursor.left)do{if(t=this._cursor,!this._ancestors.length){this._cursor=null;break}this._cursor=this._ancestors.pop()}while(this._cursor.left===t);else this._ancestors.push(this._cursor),this._maxNode(this._cursor.left)}return null!==this._cursor?this._cursor.data:null},i.prototype._minNode=function(e){for(;null!==e.left;)this._ancestors.push(e),e=e.left;this._cursor=e},i.prototype._maxNode=function(e){for(;null!==e.right;)this._ancestors.push(e),e=e.right;this._cursor=e},e.exports=r},358:function(e,t,r){e.exports={RBTree:r(724),BinTree:r(725)}},359:function(e){e.exports=JSON.parse('{"@@locale":"en","@@context":"SceneBuilder Extension","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Root","Object %(nodeId)d":"Object %(nodeId)d"}')},360:function(e){e.exports=JSON.parse('{"@@locale":"en","@@context":"SceneBuilder Extension","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Root","Object %(nodeId)d":"Object %(nodeId)d"}')},361:function(e){e.exports=JSON.parse('{"@@locale":"cs","@@context":"Rozšíření SceneBuilder","Scene Builder %(modelId)d":"Nástroj Generátor scén %(modelId)d","Root":"Kořen","Object %(nodeId)d":"Objekt %(nodeId)d"}')},362:function(e){e.exports=JSON.parse('{"@@locale":"de","@@context":"SceneBuilder-Erweiterung","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Stammverzeichnis","Object %(nodeId)d":"Objekt %(nodeId)d"}')},363:function(e){e.exports=JSON.parse('{"@@locale":"es","@@context":"Extensión SceneBuilder","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Raíz","Object %(nodeId)d":"Objeto %(nodeId)d"}')},364:function(e){e.exports=JSON.parse('{"@@locale":"fr","@@context":"Extension SceneBuilder","Scene Builder %(modelId)d":"SceneBuilder %(modelId)d","Root":"Racine","Object %(nodeId)d":"Objet %(nodeId)d"}')},365:function(e){e.exports=JSON.parse('{"@@locale":"fr-CA","@@context":"Extension SceneBuilder (générateur de scène)","Scene Builder %(modelId)d":"Générateur de scène %(modelId)d","Root":"Racine","Object %(nodeId)d":"Objet %(nodeId)d"}')},366:function(e){e.exports=JSON.parse('{"@@locale":"it","@@context":"Estensione SceneBuilder","Scene Builder %(modelId)d":"SceneBuilder %(modelId)d","Root":"Radice","Object %(nodeId)d":"Oggetto %(nodeId)d"}')},367:function(e){e.exports=JSON.parse('{"@@locale":"ja","@@context":"SceneBuilder Extension","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"ルート","Object %(nodeId)d":"オブジェクト %(nodeId)d"}')},368:function(e){e.exports=JSON.parse('{"@@locale":"ko","@@context":"SceneBuilder 확장","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"루트","Object %(nodeId)d":"Object %(nodeId)d"}')},369:function(e){e.exports=JSON.parse('{"@@locale":"pl","@@context":"Rozszerzenie SceneBuilder","Scene Builder %(modelId)d":"SceneBuilder %(modelId)d","Root":"Katalog główny","Object %(nodeId)d":"Obiekt %(nodeId)d"}')},370:function(e){e.exports=JSON.parse('{"@@locale":"pt","@@context":"Extensão SceneBuilder","Scene Builder %(modelId)d":"Gerador de cenas %(modelId)d","Root":"Raiz","Object %(nodeId)d":"Objeto %(nodeId)d"}')},371:function(e){e.exports=JSON.parse('{"@@locale":"ru","@@context":"Расширение SceneBuilder","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Корневая папка","Object %(nodeId)d":"Объект %(nodeId)d"}')},372:function(e){e.exports=JSON.parse('{"@@locale":"tr","@@context":"SceneBuilder Uzantısı","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Kök","Object %(nodeId)d":"Nesne %(nodeId)d"}')},373:function(e){e.exports=JSON.parse('{"@@locale":"zh-Hans","@@context":"场景生成器扩展","Scene Builder %(modelId)d":"场景生成器 %(modelId)d","Root":"根","Object %(nodeId)d":"对象 %(nodeId)d"}')},374:function(e){e.exports=JSON.parse('{"@@locale":"zh-Hant","@@context":"場景建置器延伸","Scene Builder %(modelId)d":"場景建置器 %(modelId)d","Root":"根","Object %(nodeId)d":"物件 %(nodeId)d"}')},375:function(e){e.exports=JSON.parse('{"@@locale":"zh-hk","@@context":"場景建置器擴充功能","Scene Builder %(modelId)d":"場景建置器 %(modelId)d","Root":"根","Object %(nodeId)d":"物件 %(nodeId)d"}')},376:function(e){e.exports=JSON.parse('{"@@locale":"nl","@@context":"SceneBuilder Extension","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Root","Object %(nodeId)d":"Object %(nodeId)d"}')},377:function(e){e.exports=JSON.parse('{"@@locale":"sv","@@context":"SceneBuilder-tillägg","Scene Builder %(modelId)d":"SceneBuilder %(modelId)d","Root":"Rot","Object %(nodeId)d":"Objekt %(nodeId)d"}')},378:function(e){e.exports=JSON.parse('{"@@locale":"da","@@context":"SceneBuilder-udvidelse","Scene Builder %(modelId)d":"Scene Builder %(model-Id)d","Root":"Rod","Object %(nodeId)d":"Objekt %(node-Id)d"}')},379:function(e){e.exports=JSON.parse('{"@@locale":"no","@@context":"SceneBuilder-utvidelse","Scene Builder %(modelId)d":"Scene Builder %(modelId)d","Root":"Rot","Object %(nodeId)d":"Objekt %(nodeId)d"}')},724:function(e,t,r){var i=r(133);function n(e){this.data=e,this.left=null,this.right=null,this.red=!0}function o(e){this._root=null,this._comparator=e,this.size=0}function a(e){return null!==e&&e.red}function s(e,t){var r=e.get_child(!t);return e.set_child(!t,r.get_child(t)),r.set_child(t,e),e.red=!0,r.red=!1,r}function d(e,t){return e.set_child(!t,s(e.get_child(!t),!t)),s(e,t)}n.prototype.get_child=function(e){return e?this.right:this.left},n.prototype.set_child=function(e,t){e?this.right=t:this.left=t},o.prototype=new i,o.prototype.insert=function(e){var t=!1;if(null===this._root)this._root=new n(e),t=!0,this.size++;else{var r=new n(void 0),i=0,o=0,l=null,u=r,c=null,f=this._root;for(u.right=this._root;;){if(null===f?(f=new n(e),c.set_child(i,f),t=!0,this.size++):a(f.left)&&a(f.right)&&(f.red=!0,f.left.red=!1,f.right.red=!1),a(f)&&a(c)){var h=u.right===l;f===c.get_child(o)?u.set_child(h,s(l,!o)):u.set_child(h,d(l,!o))}var m=this._comparator(f.data,e);if(0===m)break;o=i,i=m<0,null!==l&&(u=l),l=c,c=f,f=f.get_child(i)}this._root=r.right}return this._root.red=!1,t},o.prototype.remove=function(e){if(null===this._root)return!1;var t=new n(void 0),r=t;r.right=this._root;for(var i=null,o=null,l=null,u=1;null!==r.get_child(u);){var c=u;o=i,i=r,r=r.get_child(u);var f=this._comparator(e,r.data);if(u=f>0,0===f&&(l=r),!a(r)&&!a(r.get_child(u)))if(a(r.get_child(!u))){var h=s(r,u);i.set_child(c,h),i=h}else if(!a(r.get_child(!u))){var m=i.get_child(!c);if(null!==m)if(a(m.get_child(!c))||a(m.get_child(c))){var v=o.right===i;a(m.get_child(c))?o.set_child(v,d(i,c)):a(m.get_child(!c))&&o.set_child(v,s(i,c));var g=o.get_child(v);g.red=!0,r.red=!0,g.left.red=!1,g.right.red=!1}else i.red=!1,m.red=!0,r.red=!0}}return null!==l&&(l.data=r.data,i.set_child(i.right===r,r.get_child(null===r.left)),this.size--),this._root=t.right,null!==this._root&&(this._root.red=!1),null!==l},e.exports=o},725:function(e,t,r){var i=r(133);function n(e){this.data=e,this.left=null,this.right=null}function o(e){this._root=null,this._comparator=e,this.size=0}n.prototype.get_child=function(e){return e?this.right:this.left},n.prototype.set_child=function(e,t){e?this.right=t:this.left=t},o.prototype=new i,o.prototype.insert=function(e){if(null===this._root)return this._root=new n(e),this.size++,!0;for(var t=0,r=null,i=this._root;;){if(null===i)return i=new n(e),r.set_child(t,i),ret=!0,this.size++,!0;if(0===this._comparator(i.data,e))return!1;t=this._comparator(i.data,e)<0,r=i,i=i.get_child(t)}},o.prototype.remove=function(e){if(null===this._root)return!1;var t=new n(void 0),r=t;r.right=this._root;for(var i=null,o=null,a=1;null!==r.get_child(a);){i=r,r=r.get_child(a);var s=this._comparator(e,r.data);a=s>0,0===s&&(o=r)}return null!==o&&(o.data=r.data,i.set_child(i.right===r,r.get_child(null===r.left)),this._root=t.right,this.size--,!0)},e.exports=o},809:function(e,t,r){"use strict";r.r(t);var i=r(358);function n(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var o=[0,1],a=function(){function e(t,r,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),this._lowId=void 0===t?0:0|t,this._highId=void 0===r?4294967295:0|r,this._availableIds=new i.RBTree((function(e,t){return e[0]-t[0]})),this._availableIds.insert([this._lowId+(0|n),this._highId])}var t,r,a;return t=e,(r=[{key:"reserveId",value:function(){var e=this._availableIds.min();if(null!==e){var t=e[0];return t>=e[1]?this._availableIds.remove(e):++e[0],t}}},{key:"releaseId",value:function(e){if(e<this._lowId||e>this._highId)return!1;o[0]=e;var t=this._availableIds.lowerBound(o),r=t.data();if(null!==r){if(r[0]<=e&&r[1]>=e)return!1;t.prev();var i=t.data();e+1===r[0]?null===i||e-1>i[1]?r[0]=e:(this._availableIds.remove(r),this._availableIds.remove(i),r[0]=i[0],this._availableIds.insert(r)):null===i||e-1>i[1]?this._availableIds.insert([e,e]):i[1]=e}return!0}},{key:"isIdReserved",value:function(e){if(e<this._lowId||e>this._highId)return!1;o[0]=e;var t=this._availableIds.upperBound(o).prev();return!t||e<t[0]||e>t[1]}}])&&n(t.prototype,r),a&&n(t,a),e}();function s(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function d(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,r){return t&&d(e.prototype,t),r&&d(e,r),e}var u=Autodesk.Viewing,c=u.Private,f=new THREE.Matrix4,h=new THREE.Box3,m=new THREE.Vector3,v=new THREE.Vector3,g={svfid:0,boundingBox:new THREE.Box3},p={geometry:null,material:void 0,matrix:f,isLine:!1,isWideLine:!1,isPoint:!1},_=~(c.MeshFlags.MESH_ISLINE|c.MeshFlags.MESH_ISWIDELINE|c.MeshFlags.MESH_ISPOINT),y={type:"removed"},I=function(){function e(){var t,r,i;s(this,e),this.rootId=-1e9,this.nodeIndices=new a(1),this.dbIdToIndex=(i=0,(r=-1e9)in(t={})?Object.defineProperty(t,r,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[r]=i,t),this._nodeCount=1,this._maxIndex=0,this._nodeFlags=[0],this._indexToFragId=[],this._rootName=u.i18n.translate("Root")}return l(e,[{key:"getIndex",value:function(e){return this.dbIdToIndex[e]}},{key:"getNumNodes",value:function(){return this._maxIndex+1}},{key:"getParentId",value:function(e){return e===this.rootId?void 0:this.rootId}},{key:"getNodeFlags",value:function(e){var t=this.dbIdToIndex[e];return t>=0?this._nodeFlags[t]:void 0}},{key:"setNodeFlags",value:function(e,t){var r=this.dbIdToIndex[e];void 0!==r&&(this._nodeFlags[r]=t)}},{key:"name",value:function(e,t){return e===this.rootId?t&&this._nodeCount>1?"".concat(this._rootName,"(").concat(this._nodeCount-1,")"):this._rootName:u.i18n.translate("Object %(nodeId)d",{postProcess:"sprintf",sprintf:{nodeId:e}})}},{key:"getNodeBox",value:function(e,t){t.setEmpty()}},{key:"getNumChildren",value:function(e){return e==this.rootId?this._nodeCount-1:0}},{key:"getNumFragments",value:function(e){if(e===this.rootId)return 0;var t=this.dbIdToIndex[e];if(void 0===t)return 0;var r=this._indexToFragId[t];return Array.isArray(r)?r.length:1}},{key:"enumNodeFragments",value:function(e,t){if(e!==this.rootId){var r=this.dbIdToIndex[e];if(void 0!==r){var i=this._indexToFragId[r];if(Array.isArray(i))for(var n=0;n<i.length;++n)t(i[n],e,r);else t(i,e,r)}}}},{key:"enumNodeChildren",value:function(e,t){if(e===this.rootId)for(var r=Object.keys(this.dbIdToIndex),i=0;i<r.length;++i){var n=parseInt(r[i]);n!==this.rootId&&t(n,e,0)}}},{key:"addFragment",value:function(e,t){var r=this.dbIdToIndex[e];void 0===r&&(r=this.nodeIndices.reserveId(),this.dbIdToIndex[e]=r,this._nodeFlags[r]=0,++this._nodeCount,r>this._maxIndex&&(this._maxIndex=r));var i=this._indexToFragId[r];void 0===i?this._indexToFragId[r]=t:Array.isArray(i)?i.push(t):this._indexToFragId[r]=[i,t]}},{key:"removeFragment",value:function(e,t){var r=this.dbIdToIndex[e];if(void 0!==r){var i=this._indexToFragId[r];if(Array.isArray(i)){var n=i.indexOf(t);n>=0&&2===i.length?this._indexToFragId[r]=i[1-n]:i.splice(n,1)}else this.nodeIndices.releaseId(),delete this.dbIdToIndex[e],delete this._indexToFragId[r],--this._nodeCount}}}]),e}(),b=function(){function e(t){s(this,e),this.viewer3DImpl=t}return l(e,[{key:"loadFile",value:function(e,t,r,i){i&&i();var n,o=t.conserveMemory?1:0,a={bbox:(new THREE.Box3).set(t.globalOffset,t.globalOffset),fragments:{length:o,fragId2dbId:[0],transforms:o?new Float32Array(12*o):null,boxes:o?new Float32Array(6*o):null},is2d:!1,loadOptions:t||{},isSceneBuilder:!0,loadDone:!0,instanceTree:new c.InstanceTree(new I,0,1),metadata:{}},s=new u.Model(a);t&&t.modelNameOverride?(n=t.modelNameOverride,t.modelNameOverride=void 0):n=u.i18n.translate("Scene Builder %(modelId)d",{postProcess:"sprintf",sprintf:{modelId:s.getModelId()}}),a.instanceTree.nodeAccess._rootName=n,a.urn=btoa(n),this.svf=a,s.initialize(),s.loader=this,this.model=s,s.getFragmentList().isFixedSize=!1,r(null,s),this.viewer3DImpl.api.dispatchEvent({type:u.MODEL_ROOT_LOADED_EVENT,svf:a,model:s}),this.viewer3DImpl.onLoadComplete(s)}},{key:"dtor",value:function(){}},{key:"is3d",value:function(){return!0}}]),e}();function x(e){return e instanceof THREE.Mesh?e.fragId:e}function M(e,t,r,i,n,o){var a=x(t),s=e.model,d=e.fragList;g.geometry=(void 0===r?e.fragList.getGeometryId(a):r instanceof THREE.BufferGeometry?r.svfid:r)||0,r=void 0===r?e.fragList.getGeometry(a):e._getGeometry(r);var l=void 0===i?e.fragList.getMaterial(a):e._getMaterial(i),u=!e.conserveMemory&&s.getFragmentList().getVizmesh(a);return u?u.dispatchEvent(y):u=p,u.material=l,a<d.vizflags.length&&(d.vizflags[a]&=~_),u.geometry=r,r?(u.isLine=r.isLines,u.isWideLine=r.isWideLines,u.isPoint=r.isPoints):(u.geometry=g,u.isLine=!1,u.isWideLine=!1,u.isPoint=!1),u.matrix=function(e,t){if(e)if(e instanceof THREE.Matrix4)t.copy(e);else{var r=t.elements;r[0]=e[0],r[1]=e[1],r[2]=e[2],r[3]=0,r[4]=e[3],r[5]=e[4],r[6]=e[5],r[7]=0,r[8]=e[6],r[9]=e[7],r[10]=e[8],r[11]=0,r[12]=e[9],r[13]=e[10],r[14]=e[11],r[15]=1}else t.identity();return t}(n,u===p?f:u.matrix),p.bbox=o&&(o instanceof THREE.Box3?o:h.set(m.fromArray(o,0),v.fromArray(o,3))),d.fragments.fragId2dbId[a]=-100-a,e.instanceTree.nodeAccess.addFragment(-100-a,a),s.setFragment(a,u,u!==p),d.useThreeMesh&&!r&&(d.getVizmesh(a).geometry=null),e.sceneUpdated(!0),!0}function S(e,t){return t.makeEmpty(),c.VertexEnumerator.enumMeshVertices(e,(function(e){t.expandByPoint(e)})),t}function O(e,t,r){r instanceof THREE.MeshPhongMaterial||r instanceof THREE.ShaderMaterial&&r.isPrismMaterial?e.addMaterial(t,r,!0):e.addMaterialNonHDR(t,r)}function B(e,t,r,i){var n=0|r[t];e=e||-100-t,r[t]=e,e!==n&&(i.nodeAccess.removeFragment(n,t),i.nodeAccess.addFragment(e,t))}var k=function(){function e(t,r){s(this,e),this.model=t,this.geomList=t.getGeometryList(),this.fragList=t.getFragmentList(),this.geomIds=new a(1),this.fragmentIds=new a(Math.max(t.getData().fragments.length,1)),this.conserveMemory=!(!r||!r.conserveMemory),this.instanceTree=t.getData().instanceTree,this.instanceTree.setFragmentList(this.fragList),this.createWireframe=!(!r||!r.createWireframe)}return l(e,[{key:"isConservingMemory",value:function(){return this.conserveMemory}},{key:"addGeometry",value:function(e,t){if(e&&void 0!==e.svfid)return 0;var r=this.geomIds.reserveId();if(void 0===r)return 0;if(e){if(this.createWireframe){if(c.createWireframe(e),!e.attributes.indexlines){var i=new THREE.BufferAttribute(void 0,1);i.bytesPerItem=e.iblines instanceof Uint32Array?4:2,e.addAttribute("indexlines",i),e.iblinesbuffer=void 0}if(!e.attributes.index){for(var n=new Uint16Array(e.attributes.position.length/3),o=0;o<n.length;++o)n[o]=o;var a=new THREE.BufferAttribute(n,1);a.bytesPerItem=2,e.addAttribute("index",a)}}var s=e.boundingBox=e.boundingBox||S(e,this.conserveMemory?h:new THREE.Box3);this.geomList.addGeometry(this.packNormals(e),t,r),this.conserveMemory||(e.boundingBox=s)}return r}},{key:"_updateGeometry",value:function(e,t){var r=this.fragList,i=!1;if(this.conserveMemory)for(var n=r.geomids,o=0;o<n.length;++o)e[n[o]]&&(this.changeFragmentGeometry(o,t),i=!0);else for(var a=r.vizmeshes,s=0;s<a.length;++s){var d=a[s];d&&d.geometry&&e[d.geometry.svfid]&&(this.changeFragmentGeometry(s,t),i=!0)}i&&this.sceneUpdated(!0)}},{key:"_validateGeometry",value:function(e){Array.isArray(e)||(e=[e]);for(var t={},r=this.geomList,i=0;i<e.length;++i){var n=e[i];if(n instanceof THREE.BufferGeometry){if(r.getGeometry(n.svfid)!=n)return null;n=n.svfid}if(!this.geomIds.isIdReserved(n))return null;t[n]=!0}return t}},{key:"changeGeometry",value:function(e,t,r){var i=this._validateGeometry(e);if(!i)return!1;var n=parseInt(Object.keys(i)[0]),o=this.geomList;if(!t||t&&void 0!==t.svfid)return!1;var a=o.getGeometry(n);if(o.removeGeometry(n),void 0===r){r=0;var s=this.fragList;if(s.useThreeMesh){if(a)for(var d=s.vizmeshes,l=0;l<d.length;++l)d[l]&&d[l].geometry===a&&++r}else for(var u=s.geomids,c=0;c<u.length;++c)u[c]===n&&++r;r=r||1}var f=t.boundingBox=t.boundingBox||S(t,this.conserveMemory?h:new THREE.Box3);return o.addGeometry(this.packNormals(t),r,n),this.conserveMemory||(t.boundingBox=f),this._updateGeometry(i,n),a&&(a.svfid=void 0),!0}},{key:"findGeometryFragments",value:function(e){var t=this._validateGeometry(e),r=[],i=this.fragList;if(i.useThreeMesh)for(var n=i.vizmeshes,o=0;o<n.length;++o){t[n[o]&&n[o].geometry&&n[o].geometry.svfid]&&r.push(o)}else for(var a=i.geomids,s=0;s<a.length;++s)t[a[s]]&&r.push(s);return r}},{key:"removeGeometry",value:function(e){var t=this._validateGeometry(e);if(!t)return!1;var r=this.geomList;this._updateGeometry(t,0);for(var i=Object.keys(t),n=0;n<i.length;++n){var o=parseInt(i[n]),a=r.getGeometry(o);a&&(a.svfid=void 0),r.removeGeometry(o),this.geomIds.releaseId(o)}return!0}},{key:"addMaterial",value:function(e,t){if(!t||t.materialManagerName)return!1;e=e||"!!mtl-"+t.id;var r=this.model.loader.viewer3DImpl.matman(),i=r._getMaterialHash(this.model,e);return"__defaultMaterial__"!==e&&!r._materials[i]&&!r._materialsNonHDR[i]&&(t.packedNormals||(t.packedNormals=!0,t.needsUpdate=!0),O(r,i,t),t.materialManagerName=e,!0)}},{key:"_validateMaterials",value:function(e){Array.isArray(e)||(e=[e]);for(var t=this.model.loader.viewer3DImpl.matman(),r=[],i=0;i<e.length;++i){var n=e[i],o=void 0,a=void 0;if(n instanceof THREE.Material){if(o=n,n=n.materialManagerName,a=t._getMaterialHash(this.model,n),o!==(t._materials[a]||t._materialsNonHDR[a]))return null}else if(a=t._getMaterialHash(this.model,n),!(t._materials[a]||t._materialsNonHDR[a]))return null;r.push(a)}return r}},{key:"changeMaterial",value:function(e,t){if(!t||t.materialManagerName)return!1;var r=this._validateMaterials(e);if(!r)return!1;var i=this.model.loader.viewer3DImpl.matman(),n=r[0],o=i._materials[n]||i._materialsNonHDR[n],a=o.materialManagerName;t.packedNormals||(t.packedNormals=!0,t.needsUpdate=!0),O(i,n,t),o.materialManagerName=void 0,t.materialManagerName=a;var s=this.fragList;if(s.useThreeMesh)for(var d=s.vizmeshes,l=0;l<d.length;++l)d[l]&&d[l].material===o&&(d[l].material=t);else{var u=s.materialmap[o.id];void 0!==u&&(s.materialmap[t.id]=u,s.materialIdMap[u]=t)}return!0}},{key:"findMaterial",value:function(e){var t=this.model.loader.viewer3DImpl.matman(),r=t._getMaterialHash(this.model,e);return t._materials[r]||t._materialsNonHDR[r]}},{key:"findMaterialFragments",value:function(e){var t=this._validateMaterials(e);if(!t)return null;for(var r=this.model.loader.viewer3DImpl.matman(),i=this.fragList,n=i.useThreeMesh,o=!1,a={},s=0;s<t.length;++s){var d=r._materials[t[s]]||r._materialsNonHDR[t[s]],l=n?d.id:i.materialmap[d.id];void 0!==l&&(a[l]=!0,o=!0)}var u=[];if(o)if(n)for(var c=i.vizmeshes,f=c.length,h=0;h<f;++h){a[c[h]&&c[h].material&&c[h].material.id]&&u.push(h)}else for(var m=i.materialids,v=m.length,g=0;g<v;++g)a[m[g]]&&u.push(g);return u}},{key:"removeMaterial",value:function(e){var t=this._validateMaterials(e);if(!t)return!1;for(var r=this.model.loader.viewer3DImpl.matman(),i=this.fragList,n=i.useThreeMesh,o={},a=!1,s=0;s<t.length;++s){var d=r._materials[t[s]]||r._materialsNonHDR[t[s]];if(delete r._materials[t[s]],delete r._materialsNonHDR[t[s]],n)o[d.id]=!0,a=!0;else{var l=i.materialmap[d.id];void 0!==l&&(delete i.materialmap[d.id],delete i.materialIdMap[l],o[l]=!0,a=!0)}}if(a)if(n)for(var u=i.vizmeshes,c=0;c<u.length;++c){o[u[c]&&u[c].material&&u[c].material.id]&&i.setMaterial(c,this._getDefaultMaterial())}else for(var f=i.materialids,h=0;h<f.length;++h)o[f[h]]&&i.setMaterial(h,this._getDefaultMaterial());return!0}},{key:"addMesh",value:function(e){if(!e||this.conserveMemory||void 0!==e.modelId||void 0!==e.fragId)return!1;if(!e.geometry||!e.material)return!1;var t=e.geometry.svfid;if(t){if(this.geomList.getGeometry(t)!==e.geometry)return!1}else if(!this.addGeometry(e.geometry))return!1;var r=e.material.materialManagerName;if(r){if(this.findMaterial(r)!==e.material)return!1}else if(!this.addMaterial(void 0,e.material))return t&&this.removeGeometry(t),!1;var i=this.fragmentIds.reserveId();return e.dbId=e.dbId||-100-i,this.model.setFragment(i,e,!0),this.fragList.fragments.fragId2dbId[i]=e.dbId,this.instanceTree.nodeAccess.addFragment(e.dbId,i),this.sceneUpdated(!0),!0}},{key:"removeMesh",value:function(e){return!this.conserveMemory&&this.removeFragment(e)}},{key:"updateMesh",value:function(e,t,r){if(t&&r)return!0;Array.isArray(e)||(e=[e]);for(var i,n=0;!(i=e[n]);)if(++n>=e.length)return!0;do{i&&(t||(this.packNormals(i.geometry),i.dispatchEvent(y)),r||i.matrixWorld.copy(i.matrix)),i=e[++n]}while(n<e.length);return this.sceneUpdated(!(t&&r)),!0}},{key:"sceneUpdated",value:function(e,t){this.model.loader.viewer3DImpl.sceneUpdated(e,t)}},{key:"_validateFragment",value:function(e,t,r){if(e instanceof THREE.Mesh){if(!this.fragList.useThreeMesh||this.fragList.getVizmesh(e.fragId)!==e)return!1}else if(!this.fragmentIds.isIdReserved(e))return!1;if(t)if(t instanceof THREE.BufferGeometry){if(t.svfid&&this.geomList.getGeometry(t.svfid)!==t)return!1}else if(!this.geomIds.isIdReserved(t))return!1;if(r)if(r instanceof THREE.Material){if(r.materialManagerName&&this.findMaterial(r.materialManagerName)!==r)return!1}else if(!this.findMaterial(r))return!1;return!0}},{key:"_getGeometry",value:function(e){return e instanceof THREE.BufferGeometry?(e.svfid||this.addGeometry(e),e):this.geomList.getGeometry(e)}},{key:"_getMaterial",value:function(e){return e instanceof THREE.Material?(e.materialManagerName||this.addMaterial(void 0,e),e):this.findMaterial(e)}},{key:"addFragment",value:function(e,t,r,i){var n=this.fragmentIds,o=n.reserveId();return void 0!==o&&this._validateFragment(o,e,t)?M(this,o,e,t,r,i)?o:(n.releaseId(o),0):0}},{key:"changeFragmentGeometry",value:function(e,t,r,i){if(!this._validateFragment(e,t))return!1;var n=x(e);return!!M(this,e,t,void 0,r=r||(this.fragList.getOriginalWorldMatrix(n,f),f),i)}},{key:"_getDefaultMaterial",value:function(){if(this._defaultMaterial)return this._defaultMaterial;var e=this.model.loader.viewer3DImpl.matman(),t=e.defaultMaterial.clone();return t.packedNormals=!0,t.needsUpdate=!0,e.addMaterial(e._getMaterialHash(this.model,"__defaultMaterial__"),t),this._defaultMaterial=t,t.materialManagerName="__defaultMaterial__",t}},{key:"changeFragmentMaterial",value:function(e,t){if(!this._validateFragment(e,void 0,t))return!1;var r=this._getMaterial(t)||this._getDefaultMaterial();return this.fragList.setMaterial(x(e),r),this.sceneUpdated(!1),!0}},{key:"changeFragmentTransform",value:function(e,t,r){if(!t||!this._validateFragment(e))return!1;var i=x(e);return!!this.changeFragmentGeometry(i,this.fragList.getGeometryId(i),t,r)&&(this.sceneUpdated(!0),!0)}},{key:"changeFragmentsDbId",value:function(e,t){Array.isArray(e)||(e=[e]),t|=0;for(var r=0;r<e.length;++r)if(!this._validateFragment(e[r]))return!1;var i=this.fragList.fragments,n=this.instanceTree,o=i.fragId2dbId;if(this.conserveMemory)for(var a=0;a<e.length;++a){B(t,x(e[a]),o,n)}else for(var s=this.fragList.vizmeshes,d=0;d<e.length;++d){var l=x(e[d]);B(t,l,o,n),s[l].dbId=t}return!0}},{key:"removeFragment",value:function(e){Array.isArray(e)||(e=[e]);for(var t=0;t<e.length;++t)if(!this._validateFragment(e[t]))return!1;for(var r=this.fragList.fragments,i=this.instanceTree,n=this.conserveMemory?this.fragList.geomids:this.fragList.vizmeshes,o=this.conserveMemory?0:null,a=0;a<e.length;++a){var s=x(e[a]);this.fragmentIds.releaseId(s),i.nodeAccess.removeFragment(r.fragId2dbId[s],s),r.fragId2dbId[s]=0,!this.conserveMemory&&n[s]&&(n[s].dispatchEvent(y),n[s].fragId=n[s].modelId=void 0),n[s]=o}return this.sceneUpdated(!0),!0}},{key:"packNormals",value:function(e){var t=e.attributes,r=t.normal;if(!r||3!==r.itemSize)return e;function i(e,t,r,i,n,o){for(var a=Math.atan2,s=1/Math.PI;t<e.length;t+=r,n+=o){var d=.5*(a(e[t+1],e[t])*s+1),l=.5*(e[t+2]+1);i[n]=65535*d|0,i[n+1]=65535*l|0}}if(r.array){var n=Math.floor(r.length/r.itemSize),o=new Uint16Array(2*n);i(r.array,0,3,o,0,2),r.itemSize=2,r.array=o,r.normalize=!0,r.needsUpdate=!0,r.bytesPerItem=2}else{var a=e.vbstride,s=e.vb,d=Math.floor(s.length/a),l=new Float32Array((a-2)*d),u=r.itemOffset;if(u<=0||u+3>=a)for(var f=u<=0?3:0,h=u<=0?1:0,m=a-3,v=0;v<d;++v,f+=3,h+=1)for(var g=0;g<m;++g)l[h++]=s[f++];else for(var p=0,_=0,y=u,I=a-u-3,b=0;b<d;++b){for(var x=0;x<y;++x)l[_++]=s[p++];p+=3,_+=1;for(var M=0;M<I;++M)l[_++]=s[p++]}i(s,u,a,new Uint16Array(l.buffer),2*u,2*(a-2)),e.vbstride-=2,e.vb=l,e.vbNeedsUpdate=!0,t.normal=c.BufferGeometryUtils.findBufferAttribute("normal",{array:null,bytesPerItem:2,itemSize:2,normalize:!0,isPattern:r.isPattern,divisor:r.divisor,offset:r.itemOffset},e.numInstances);for(var S=Object.keys(t),O=0;O<S.length;++O){var B=t[S[O]];!B.array&&B.itemOffset>u&&(t[S[O]]=c.BufferGeometryUtils.findBufferAttribute(S[O],{array:null,bytesPerItem:B.bytesPerItem,itemSize:B.itemSize,normalize:B.normalize,isPattern:B.isPattern,divisor:B.divisor,offset:B.itemOffset-2},e.numInstances))}}return e}}],[{key:"addNewModel",value:function(t,r){return new Promise((function(i,n){var o=Object.assign({},r);o.fileLoader=b,o.globalOffset=o.globalOffset||{x:0,y:0,z:0},t.viewer.loadModel("Dummy",o,(function(t){i(new e(t,o))}),(function(e){n(e)}))}))}}]),e}(),N={en:r(359),"en-GB":r(360),cs:r(361),de:r(362),es:r(363),fr:r(364),"fr-CA":r(365),it:r(366),ja:r(367),ko:r(368),pl:r(369),"pt-BR":r(370),ru:r(371),tr:r(372),"zh-HANS":r(373),"zh-HANT":r(374),"zh-HK":r(375),nl:r(376),sv:r(377),da:r(378),no:r(379)};function E(e){return(E="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function w(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function R(e,t){return(R=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function T(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,i=F(e);if(t){var n=F(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return j(this,r)}}function j(e,t){return!t||"object"!==E(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function F(e){return(F=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}var L=Autodesk.Viewing,z=function(e){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&R(e,t)}(o,e);var t,r,i,n=T(o);function o(e,t){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,o),(r=n.call(this,e,t))._loaded=!1,r.extendLocalization(N),r}return t=o,(r=[{key:"load",value:function(){return this._loaded=!0,!0}},{key:"unload",value:function(){return this._loaded=!1,!0}},{key:"addNewModel",value:function(e){return this._loaded?k.addNewModel(this,Object.assign({},this.options,e)):Promise.reject(new Error("SceneBuilder extension not loaded"))}}])&&w(t.prototype,r),i&&w(t,i),o}(L.Extension);L.theExtensionManager.registerExtension("Autodesk.Viewing.SceneBuilder",z)}});
//# sourceMappingURL=SceneBuilder.min.js.map